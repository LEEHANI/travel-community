<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>Insert title here</title>

<!-- include libraries(jQuery, bootstrap) -->
<th:block th:replace="/common/html/head.html"></th:block>


<style>
#search{
	width:80%;
	display:inline;
}
</style>

</head>
<body>
	
	<th:block th:replace="/common/html/navBar.html"></th:block>

	<div class="container mt-5">
		<div class="row">
			<div class="col-12">
				<ul id="nation-nav" class="nav nav-tabs justify-content-center">
					<li class="nav-item"><a class="nav-link" href="./all">전체</a></li>
					<li class="nav-item"><a class="nav-link" href="./tw">대만</a></li>
					<li class="nav-item"><a class="nav-link" href="./la">라오스</a></li>
					<li class="nav-item"><a class="nav-link" href="./my">말레이시아</a></li>
					<li class="nav-item"><a class="nav-link" href="./vn">베트남</a></li>
					<li class="nav-item"><a class="nav-link" href="./sg">싱가폴</a></li>
					<li class="nav-item"><a class="nav-link" href="./jp">일본</a></li>
					<li class="nav-item"><a class="nav-link" href="./cn">중국</a></li>
					<li class="nav-item"><a class="nav-link" href="./th">태국</a></li>
				</ul>
			</div>
		</div>
	  <div class="row mt-4 justify-content-center">
	    <div class="col col-lg-2">
	      <h1>글목록</h1>
	    </div>
	  </div>
		<div class="row">
			<div class="col">
				<div id="sort-group" class="btn-group" role="group">
					<a type="button" class="btn btn-secondary" id="newest">최신순</a>
					<a type="button" class="btn btn-secondary" id="popular">인기순</a>
				</div>
			</div>
			<div class="justify-content-right">
				<div class="search-group">
					<input class="form-control" type="text" id="search" placeholder="제목 검색"/>
					<i class="fas fa-search" id="search-icon"></i>
				</div>
			</div>
		</div>
	</div>

	
	<div class="container mt-2">
		<table class="table table-striped">
			<thead>
				<tr>
					<th scope="col">번호</th>
					<th scope="col">제목</th>
					<th scope="col">날짜</th>
					<th scope="col">조회수</th>
				</tr>
			</thead>
			<tr th:each="article,iterStat : ${page.list}">
				<th scope="row" th:text="${iterStat.count} + ${page.currentPageNo-1}*${page.recordsPerPage}"></th>
				<td><a th:href="@{/article/{id}(id=${article.id})}">
						<span th:utext="|[${article.nation}]| "></span>
						<span th:utext="|${article.title}|"></span>
						<span th:utext="|[${article.commentCnt}]|"></span>
					</a>
				</td>
				<td th:text="${#temporals.format(article.registerDate, 'yyyy-MM-dd HH:mm')}"></td>
				<td th:text="${article.hit}"></td>
			</tr>
		</table>
		<div class="row justify-content-between mb-3">
			<div class="col-4 float-left mt-2">
				<h5 th:text="|Total : ${page.numberOfRecords}|"></h5>
			</div>
			<div class="col-2">
				<button class="btn btn-primary float-right" onclick="window.location.href='./write'">글쓰기</button>
			</div>
		</div>
	</div>
	
	<th:block th:replace="common/html/pagination.html"></th:block>
	
	<script th:src="@{/common/js/urlParser.js}"></script>
	<script>
		$(function() {
			var url = location.pathname;
			var queryString = location.search;
			var paramMap = queryStringToObject(queryString);
			
			sortHref($("#newest"), url, paramMap);
			sortHref($("#popular"), url, paramMap);
			makePageLink(url, paramMap);
			makeNationActive(url);
			makeSortActive(paramMap);
						
			$("#search-icon").on("click", function() {
				search(url, paramMap);
			});
		});
		
		function makeSortActive(paramMap){
			var sortButtons = $("#sort-group").children('a');
			var curSort = paramMap['sort'] ? paramMap['sort'] : "newest";
			for(sortButton of sortButtons){
				var sortVal = sortButton.getAttribute("id");
				if(curSort === sortVal){
					sortButton.setAttribute('class', sortButton.getAttribute('class') + ' active');
				}
				
			}
		} 
		
		function makeNationActive(url){
			var navLinks = $("#nation-nav > li.nav-item").children('a.nav-link');
			var curNation = url.slice(url.lastIndexOf('/')+1);	
			for(navLink of navLinks){
				nation = navLink.getAttribute("href").slice(2);
				if(curNation === nation){
					navLink.setAttribute("class", navLink.getAttribute("class")+ " active");
				}
			}
		}
		
		function makePageLink(url, paramMap){
			var pageLinks = $(".page-link");
			for(pageLink of pageLinks){
				var pageNo = pageLink.getAttribute("href");
				paramMap['page'] = pageNo;
				var qs = objectToQueryString(paramMap);
				pageLink.setAttribute("href", url+qs);
			}
		}

		function sortHref(obj, url, params) {
			const params_copy = {...params};
			params_copy["sort"] = obj.attr("id");
			var qs = objectToQueryString(params_copy);
			obj.attr("href", url + qs);
		}
		
		function search(url, paramMap) {
			var search = $("#search").val().trim();

			if (search == "") {
				alert("검색할 내용을 넣어주세요.");
			} else {
				paramMap["search"] = search;
				window.location.href = url + objectToQueryString(paramMap);
			}
		}

	</script>
</body>
</html>
