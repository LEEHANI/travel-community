<!DOCTYPE html>
<html>
<head xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8">
<title>Detail</title>

<script
	src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
<script src="/js/article/detail.js"></script>

<th:block th:replace="common/html/head.html"></th:block>

</head>
<style>
.icon{
	padding: 0;
    border: none;
    background-color: white;
    width: 30px;
}

.icon>img{
    width: inherit;
}

.control-button{
	float:right;
	margin-right: 5px;
}

footer{
	position: absolute;
	left:0;
	bottom:0;
	width:100%;
	background-color: black;
}

.list-type{
	list-style-type: none;
	padding-left: 15px;

}

#rdo-text-area{
	display:none;
	width:530px;
	height:80px;
	margin-left: 10px;
}

.len-count{
	display:none;
}

 .pb-cmnt-container {
     font-family: Lato;
     margin-top: 10px;
 }

 .pb-cmnt-textarea {
     resize: none;
     padding: 20px;
     height: 130px;
     width: 100%;
     border: 1px solid; 
 }
 .panel {
 	margin: 10px;
 }
</style>

<body>

<th:block th:replace="common/html/navBar.html"></th:block>

	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="article-nation" th:text="|[${article.nation}]|"></div>
                     	<div class="card-title" th:utext="${article.title}"></div>
                     	<div class="meta-info row">
                     		<div class="col">
	                    		<span style="display:none" id="articleId" th:text="${article.id}" ></span>
	                    		<span id="email" th:text="${article.email}" ></span>
	                       		<small th:utext="${#temporals.format(article.registerDate, 'yyyy-MM-dd HH:mm')}"></small>
	                       		<small th:if="${article.updateDate}!=null" th:utext="|마지막 수정일자 : ${article.updateDate}|"></small>
	                        </div>
	                        <div class="col text-right">
		                        <small class="card-text">조회 : </small>
		                        <small class="card-text" th:text="${article.hit}"></small>
		                        <small class="card-text">댓글 : </small>
		                        <small class="card-text commentCount" th:text="${article.commentCnt}"></small>
		                        <small class="card-text">좋아요  : </small>
		                        <small class="card-text likeCount" th:text="${article.good}"></small>
                     		</div>
                    	</div>
					</div>
					<div class="card-body" th:utext="${article.content}"></div>
				</div>
			</div>
		</div>
		<div class="row mt-1">
			<div class="col">
				<button class="icon" id="icon-like">
					<img th:if="${liked} eq 1" id="like" th:name="${liked}" src="/img/imgs/like2.png">
					<img th:unless="${liked} eq 1" id="like" th:name="${liked}" th:src="@{/img/imgs/like1.png}">
				</button>
				<span th:text="${article.good}" class="likeCount">좋아요 숫자</span>
				<button class="icon" id="icon-bookmark">
					<img th:if="${bookmark} eq 1" id="bookmark" th:name="${bookmark}" src="/img/imgs/bookmark2.png">
					<img th:unless="${bookmark} eq 1" id="bookmark" th:name="${bookmark}" th:src="@{/img/imgs/bookmark1.png}">
				</button>
				<button class="icon" id="icon-report">
					<img id="report" src="/img/imgs/report.png">
				</button>
			</div>
			<div class="col">
				<span class="control-button">
					<button class="btn btn-primary"
							th:if="${session.memberId} == ${article.memberId}"
							th:onclick="|window.location.href='/article/update/${article.id}'|">수정하기</button>
					<button class="btn btn-danger"
							th:if="${session.memberId} == ${article.memberId}"
							th:onclick="|window.location.href='/article/delete/${article.id}'|">삭제하기</button>
				</span>
			</div>
		</div>
	</div>
	
	<div class="container mt-4">
        <div class="commentList" id="commentList"></div>
    </div>

	<div class="container pb-cmnt-container" id="commentInsert">
	    <div class="row" style="background-color:#F8F8F8">
	        <div class="col-md-10 col-md-offset-1">
	            <div class="panel panel-default">
	                <div class="panel-body">
	                	<span><strong id="writer"></strong></span>
	                    <textarea placeholder="댓글을 입력해주세요" class="pb-cmnt-textarea" id="commentContent" name="commentContent"
	                    onkeyup="checkLength(this,$('#comment-len-count'), 300)"></textarea>
                    	<span id="comment-len-count"> 0 / 300 자</span>
                        <button class="btn btn-primary pull-right" type="button" id="comment-insert">등록</button>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>

	<!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel" th:utext="|제목 : ${article.title}|">Modal title</h5>
                    <h5 class="modal-title" th:utext="|작성자 : ${article.email}|">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h4>사유 선택 : 대표적인 사유를 선택해주세요.</h4>
                	<ul class="list-type">
	                    <li><input type="radio" name="checkInfo" id="rdo-illegal" value="1" checked="checked">부적절한 홍보 게시글</li>
	                    <li><input type="radio" name="checkInfo" id="rdo-obscenity" value="2">음란성 또는 청소년에게 부적합한 내용</li>
	                    <li><input type="radio" name="checkInfo" id="rdo-libel" value="3">명예훼손/사생활 침해 등 저작권침해 행위</li>
	                    <li><input type="radio" name="checkInfo" id="rdo-etc" value="4">기타</li>
                    </ul>
                    	<textarea id="rdo-text-area" name="reportDesc" cols="50" rows="5" placeholder="해당 신고는 커뮤니티 운영자에게 전달되며, 부적절한 내용으로 판단될 경우 해당 게시물은 삭제됩니다." onkeyup="checkLength(this,$('#report-len-count'), 200)"></textarea>
                    	<span id="report-len-count" class="len-count">0 / 200 자</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="submit-report"data-dismiss="modal">신고하기</button>
                </div>
            </div>
        </div>
    </div>


<script th:inline="javascript">
		$(document).ready(function(){
			/* <![CDATA[ */
			var articleId = [[${article.id}]]
			var liked = [[${liked}]]
			/* ]] */
			var likeIcon = $("#icon-like");
			
			$("#icon-like").on("click", function(){
 				$.ajax({
					url : '/article/like',
					type : 'POST',
					data : {'articleId': articleId},
					async : false,
					success : function(liked){
						likeIcon.prop("name", liked);
						if(liked){
							$("#like").prop("src", "/img/imgs/like2.png");
						} else {
							$("#like").prop("src", "/img/imgs/like1.png");
						}
					},
					complete : function(response){
						if(response.status == 302){
							window.location.href=response.responseText;
						}
					}
				});
				
				$.ajax({
					url : '/article/like',
					type : 'GET',
					data : {'articleId' : articleId},
					success : function(count){
						console.log(count);
						$(".likeCount").html(count);
					}
				})
			});
			
			$("#icon-bookmark").on("click", function(){
				$.ajax({
					url: '/ajax/bookmark',
					type : 'POST',
					data : {'articleId' : articleId},
					success : function(bookmark){
						$("#icon-bookmark").prop("name", bookmark);
						if(bookmark){
							$("#bookmark").prop("src", "/img/imgs/bookmark2.png");
						} else{
							$("#bookmark").prop("src", "/img/imgs/bookmark1.png");
						}
					},
					complete : function(response){
						if(response.status == 302){
							window.location.href=response.responseText;
						}
					}
				})
			});
			$("#icon-report").on("click", function(){
				$.ajax({
					url : '/ajax/login_check',
					type : 'GET',
					success: function(data){
						$('#exampleModal').modal('show');				
					},
					complete : function(response){
						if(response.status == 302){
							alert("로그인이 필요한 작업입니다.");
							window.location.href=response.responseText;
						}
					}
				})
				
			})
			
			$("input:radio[name=checkInfo]").on("click", function(){
				if($("input[name=checkInfo]:checked").val() == 4){
					$("#rdo-text-area").css("display", "block");
					$("#report-len-count").css("display", "block");
				} else{
					$("#rdo-text-area").css("display", "none");
					$("#report-len-count").css("display", "none");
				}
			})
			
			$("#submit-report").on("click", function(){
				var checkInfo = $("input[name=checkInfo]:checked").val();
				var sendData = {'articleId':articleId, 'checkInfo':checkInfo};
				if(checkInfo == 4){
					reportContent = $("#rdo-text-area").val();
					sendData['reportContent'] = reportContent;
				}
				$.ajax({
					url : '/ajax/report/article',
					type : 'POST',
					data : sendData,
					success : function(data){
						alert("신고가 접수되었습니다.");
					}
				});
			});
		});
		
		function checkLength(obj, target, length){
			var content = $(obj).val();
			target.html(`(${content.length} / ${length} 자)`);
			
			if(content.length > length){
				$(obj).val(content.substring(0,length-1));
				target.html(`(${length} / ${length} 자)`);
			}
		}
	</script>
</body>
</html>